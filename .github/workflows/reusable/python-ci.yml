name: Python CI
on:
  workflow_call:
    inputs:
      python-versions: { required: false, type: string, default: '["3.12"]' }
      pkg-manager:     { required: false, type: string, default: "auto" }
      lint:            { required: false, type: boolean, default: true }
      typecheck:       { required: false, type: boolean, default: true }
      coverage:        { required: false, type: boolean, default: true }
      security-check:  { required: false, type: boolean, default: true }
      pip-audit:       { required: false, type: boolean, default: true }
permissions:
  contents: read
jobs:
  py:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(inputs.python-versions) }}
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.1.7
        with:
          fetch-depth: 0
      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.version }}
          cache: 'pip'
      - name: Install deps (auto-detect manager)
        run: |
          set -e
          if [[ "${{ inputs.pkg-manager }}" == "uv" ]] || [[ -f "uv.lock" ]]; then
            pip install uv
            uv sync --frozen
          elif [[ -f "poetry.lock" ]]; then
            pip install poetry
            poetry install --no-interaction --no-root
          elif [[ -f "pdm.lock" ]]; then
            pip install pdm
            pdm install
          elif compgen -G "requirements*.txt" > /dev/null; then
            python -m pip install -r requirements.txt
          else
            python -m pip install -e .[test] || true
          fi
      - if: inputs.lint
        name: Lint with ruff
        run: |
          python -m pip install ruff
          ruff check .
          ruff format --check .
      - if: inputs.typecheck
        name: Type check with mypy
        run: |
          python -m pip install mypy
          mypy . || true
      - name: Run tests
        run: |
          python -m pip install pytest pytest-xdist pytest-cov
          pytest -n auto --maxfail=1 --cov --cov-report=term-missing
      - if: inputs.coverage
        name: Generate coverage
        run: coverage xml -o coverage.xml || true
      - if: inputs.coverage && always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork != true)
        uses: codecov/codecov-action@4fe8c5f003fae66aa5ebb77cfd3eaf9f93d6a8dc # v4.5.0
        with:
          files: coverage.xml
          flags: python
      - if: inputs.security-check
        name: Security check
        run: |
          python -m pip install bandit[toml]
          bandit -r . -ll || true
      - if: inputs.pip-audit
        name: Dependency vulnerability audit (pip-audit)
        run: |
          python -m pip install pip-audit
          # Try multiple project layouts
          if compgen -G "requirements*.txt" > /dev/null; then
            pip-audit -r requirements.txt || true
          else
            pip-audit || true
          fi
